/*
Copyright 2013, KISSY v1.40dev
MIT Licensed
build time: Oct 28 10:16
*/
KISSY.add("promise",function(k,l){function u(a){"undefined"!==typeof console&&console.error&&console.error(a)}function p(a,b,d){if(a instanceof g)q(function(){d.call(a,a[e])});else{var m=a[e],c=a[i];c?c.push([b,d]):n(m)?p(m,b,d):b&&q(function(){b.call(a,m)})}}function f(a){if(!(this instanceof f))return new f(a);this.promise=a||new c;this.promise.defer=this}function n(a){return a&&a instanceof c}function c(a){this[e]=a;a===l&&(this[i]=[],this[o]=[])}function g(a){if(a instanceof g)return a;c.apply(this,
arguments);this[e]instanceof c&&"assert.not(this.__promise_value instanceof promise) in Reject constructor";return this}function j(a,b,d){function m(a){try{return b?b.call(this,a):a}catch(d){return u(d.stack||d),new g(d)}}function e(a){try{return d?d.call(this,a):new g(a)}catch(b){return u(b.stack||b),new g(b)}}function v(a){h?"already done at fulfilled":a instanceof c?"assert.not(value instanceof Promise) in when":(h=1,r.resolve(m.call(this,a)))}var r=new f,h=0;a instanceof c?p(a,v,function(a){h?
"already done at rejected":(h=1,r.resolve(e.call(this,a)))}):v(a);return r.promise}function s(a){return!t(a)&&n(a)&&a[i]===l&&(!n(a[e])||s(a[e]))}function t(a){return n(a)&&a[i]===l&&a[e]instanceof g}var e="__promise_value",q=k.setImmediate,o="__promise_progress_listeners",i="__promise_pendings";f.prototype={constructor:f,resolve:function(a){var b=this.promise,d;if(!(d=b[i]))return null;b[e]=a;d=[].concat(d);b[i]=l;b[o]=l;k.each(d,function(a){p(b,a[0],a[1])});return a},reject:function(a){return this.resolve(new g(a))},
notify:function(a){k.each(this.promise[o],function(b){q(function(){b(a)})})}};c.prototype={constructor:c,then:function(a,b,d){d&&this.progress(d);return j(this,a,b)},progress:function(a){this[o]&&this[o].push(a);return this},fail:function(a){return j(this,0,a)},fin:function(a){return j(this,function(b){return a(b,!0)},function(b){return a(b,!1)})},done:function(a,b){(a||b?this.then(a,b):this).fail(function(a){setTimeout(function(){throw a;},0)})},isResolved:function(){return s(this)},isRejected:function(){return t(this)}};
k.extend(g,c);KISSY.Defer=f;KISSY.Promise=c;c.Defer=f;k.mix(c,{when:j,isPromise:n,isResolved:s,isRejected:t,all:function(a){var b=a.length;if(!b)return null;for(var d=f(),c=0;c<a.length;c++)(function(c,e){j(c,function(c){a[e]=c;0===--b&&d.resolve(a)},function(a){d.reject(a)})})(a[c],c);return d.promise},async:function(a){return function(){function b(a,b){var h;try{h=f[a](b)}catch(i){return new g(i)}return h.done?h.value:j(h.value,c,e)}function c(a){return b("next",a)}function e(a){return b("throw",
a)}var f=a.apply(this,arguments);return c()}}});return c});
